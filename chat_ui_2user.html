<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Chat Test UI</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel –¥–ª—è JSX –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root" class="h-screen"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    function ChatApp({ apiBase, wsBase, token, userId }) {
      const [rooms, setRooms] = useState([]);
      const [activeRoom, setActiveRoom] = useState(null);
      const [messages, setMessages] = useState([]);
      const [hasMore, setHasMore] = useState(true);
      const [offset, setOffset] = useState(0);
      const [text, setText] = useState('');
      const [file, setFile] = useState(null);

      const wsRef = useRef(null);
      const bottomRef = useRef(null);

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
      useEffect(() => {
        fetch(`${apiBase}/rooms/`, {
          headers: { "X-Auth-Token": `${token}` }
        })
          .then(res => res.json())
          .then(data => setRooms(data))
          .catch(console.error);
      }, []);

      // –í—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç—ã –∏ —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
      const selectRoom = useCallback(room => {
        if (wsRef.current) wsRef.current.close();
        setActiveRoom(room);
        setMessages([]);
        setOffset(0);
        setHasMore(true);
      }, []);

      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WebSocket –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã
      useEffect(() => {
        if (!activeRoom) return;
        const ws = new WebSocket(`${wsBase}/ws/chat/${activeRoom.id}?token=${encodeURIComponent(token)}`);
        // ws.onopen = () => {
        //   ws.send(JSON.stringify({ type: 'auth', data: { token } }));
        // };
        ws.onmessage = e => {
          const msg = JSON.parse(e.data);
          if (msg.type === 'message' || msg.type === 'status') {
            setMessages(prev => [...prev, msg.data]);
            scrollToBottom();
          }
        };
        ws.onerror = e => console.error('WebSocket error', e);
        wsRef.current = ws;
        return () => ws.close();
      }, [activeRoom]);

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (offset-based)
      const loadHistory = useCallback(() => {
        if (!activeRoom || !hasMore) return;
        fetch(`${apiBase}/rooms/${activeRoom.id}/messages/?offset=${offset}&limit=50`, {
          headers: { "X-Auth-Token": `${token}` }
        })
          .then(res => res.json())
          .then(batch => {
            setMessages(prev => [...batch.reverse(), ...prev]);
            setOffset(prev => prev + batch.length);
            if (batch.length < 50) setHasMore(false);
          })
          .catch(console.error);
      }, [activeRoom, offset, hasMore]);

      // Infinite scroll: –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –≤–µ—Ä—Ö–∞ —Å–ø–∏—Å–∫–∞
      useEffect(() => {
        const container = document.getElementById('messages');
        if (!container) return;
        const firstMsg = container.firstChild;
        if (!firstMsg || !hasMore) return;
        const observer = new IntersectionObserver(entries => {
          if (entries[0].isIntersecting) {
            loadHistory();
          }
        }, { root: container, threshold: 0.1 });
        observer.observe(firstMsg);
        return () => observer.disconnect();
      }, [messages]);

      const scrollToBottom = () => {
        bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
      };

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      const sendMessage = () => {
        if (!text.trim()) return;
        wsRef.current.send(JSON.stringify({ type: 'message', data: { content: text } }));
        setText('');
      };

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–ª–æ–∂–µ–Ω–∏—è
      const sendAttachment = () => {
        if (!file) return;
        const form = new FormData();
        form.append('file', file);
        form.append('file_type', file.type);
        fetch(`${apiBase}/rooms/${activeRoom.id}/attachments`, {
          method: 'POST',
          headers: { "X-Auth-Token": `${token}` },
          body: form
        })
        .then(() => setFile(null))
        .catch(console.error);
      };

      return (
        <div className="flex h-screen">
          {/* –°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç */}
          <aside className="w-1/4 border-r p-4 overflow-y-auto bg-white">
            <h2 className="text-xl mb-4">–ú–æ–∏ —á–∞—Ç—ã</h2>
            {rooms.map(room => (
              <div
                key={room.id}
                className={`p-2 mb-2 rounded cursor-pointer ${activeRoom?.id === room.id ? 'bg-blue-200' : 'hover:bg-gray-100'}`}
                onClick={() => selectRoom(room)}
              >
                –ó–∞–∫–∞–∑: {room.order_id.slice(0,8)}‚Ä¶
              </div>
            ))}
          </aside>

          {/* –û–∫–Ω–æ —á–∞—Ç–∞ */}
          <div className="flex-1 flex flex-col bg-gray-50">
            {activeRoom ? (
              <>
                <div id="messages" className="flex-1 p-4 overflow-y-auto">
                  {messages.map(m => (
                    <div key={m.id} className={`msg my-1 max-w-md break-words p-2 rounded ${m.sender_id === userId ? 'self-end bg-blue-100' : 'self-start bg-gray-100'}`}>
                      <div>{m.content}</div>
                      {m.attachments && m.attachments.map(att => (
                        <div key={att.id} className="mt-1">
                          <a href={att.file_url} target="_blank" rel="noopener noreferrer" className="text-blue-600 underline">{att.file_type}</a>
                        </div>
                      ))}
                    </div>
                  ))}
                  <div ref={bottomRef}></div>
                </div>

                <div className="p-4 border-t flex items-center bg-white">
                  <input
                    type="file"
                    className="mr-2"
                    onChange={e => setFile(e.target.files[0])}
                  />
                  <button onClick={sendAttachment} disabled={!file} className="mr-4 px-4 py-2 bg-green-500 text-white rounded disabled:opacity-50">üìé</button>
                  <input
                    value={text}
                    onChange={e => setText(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && sendMessage()}
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"
                    className="flex-1 border rounded px-2 py-1 mr-2"
                  />
                  <button onClick={sendMessage} className="px-4 py-2 bg-blue-500 text-white rounded">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
              </>
            ) : (
              <div className="flex-1 flex items-center justify-center text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞</div>
            )}
          </div>
        </div>
      );
    }

    // –†–µ–Ω–¥–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –∑–∞–º–µ–Ω–∏—Ç–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
    ReactDOM.render(
      <ChatApp
        apiBase="http://localhost:8080/api/chat"
        wsBase="ws://localhost:8080/api/chat"
        token="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNGFjNjFlNjktOWM5YS00YTU1LTgzMDUtZGNlY2NhM2QxMmFkIiwic3RhdHVzIjoiXHUwNDFkXHUwNDM1IFx1MDQzMlx1MDQzNVx1MDQ0MFx1MDQzOFx1MDQ0NFx1MDQzOFx1MDQ0Nlx1MDQzOFx1MDQ0MFx1MDQzZVx1MDQzMlx1MDQzMFx1MDQzZCIsInR5cGUiOiJBQ0NFU1MiLCJleHAiOjE3NDgxNzE4NjN9.tapMvte7gzDoDfMOfE0ckgSPoFTWdtJrAT-wfObXF_Q"
        userId="4ac61e69-9c9a-4a55-8305-dcecca3d12ad"
      />,
      document.getElementById('root')
    );
  </script>
</body>
</html>
